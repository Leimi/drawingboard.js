/* drawingboard.js v0.4.3 - https://github.com/Leimi/drawingboard.js
* Copyright (c) 2014 Emmanuel Pelletier
* Licensed MIT */
(function(){window.DrawingBoard="undefined"!=typeof DrawingBoard?DrawingBoard:{},DrawingBoard.Board=function(a,b){var c;return this.opts=this.mergeOptions(b),this.ev=new DrawingBoard.Utils.MicroEvent,this.id=a,this.$el=$(document.getElementById(a)),this.$el.length?(c='<div class="drawing-board-canvas-wrapper"></canvas><canvas class="drawing-board-canvas"></canvas><div class="drawing-board-cursor drawing-board-utils-hidden"></div></div>',this.opts.controlsPosition.indexOf("bottom")>-1?c+='<div class="drawing-board-controls"></div>':c='<div class="drawing-board-controls"></div>'+c,this.$el.addClass("drawing-board").append(c),this.dom={$canvasWrapper:this.$el.find(".drawing-board-canvas-wrapper"),$canvas:this.$el.find(".drawing-board-canvas"),$cursor:this.$el.find(".drawing-board-cursor"),$controls:this.$el.find(".drawing-board-controls")},$.each(["left","right","center"],$.proxy(function(a,b){return this.opts.controlsPosition.indexOf(b)>-1?(this.dom.$controls.attr("data-align",b),!1):void 0},this)),this.canvas=this.dom.$canvas.get(0),this.ctx=this.canvas&&this.canvas.getContext&&this.canvas.getContext("2d")?this.canvas.getContext("2d"):null,this.color=this.opts.color,this.ctx?(this.storage=this._getStorage(),this.initHistory(),this.reset({webStorage:!1,history:!1,background:!1}),this.initControls(),this.resize(),this.reset({webStorage:!1,history:!0,background:!0}),this.restoreWebStorage(),this.initDropEvents(),void this.initDrawEvents()):(this.opts.errorMessage&&this.$el.html(this.opts.errorMessage),!1)):!1},DrawingBoard.Board.defaultOpts={controls:["Color","DrawingMode","Size","Navigation"],controlsPosition:"top left",color:"#000000",size:1,background:"#fff",eraserColor:"background",fillTolerance:100,webStorage:"session",droppable:!1,enlargeYourContainer:!1,errorMessage:'<p>It seems you use an obsolete browser. <a href="http://browsehappy.com/" target="_blank">Update it</a> to start drawing.</p>'},DrawingBoard.Board.prototype={mergeOptions:function(a){return a=$.extend({},DrawingBoard.Board.defaultOpts,a),a.background||"background"!==a.eraserColor||(a.eraserColor="transparent"),a},reset:function(a){a=$.extend({color:this.opts.color,size:this.opts.size,webStorage:!0,history:!0,background:!1},a),this.setMode("pencil"),a.background&&this.resetBackground(this.opts.background,!1),a.color&&this.setColor(a.color),a.size&&(this.ctx.lineWidth=a.size),this.ctx.lineCap="round",this.ctx.lineJoin="round",a.webStorage&&this.saveWebStorage(),a.history&&this.saveHistory(),this.blankCanvas=this.getImg(),this.ev.trigger("board:reset",a)},resetBackground:function(a,b){var c,d;a=a||this.opts.background,b="undefined"!=typeof b?b:!0,c=DrawingBoard.Utils.isColor(a),d=this.getMode(),this.setMode("pencil"),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.width),c?(this.ctx.fillStyle=a,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)):a&&this.setImg(a),this.setMode(d),b&&this.saveHistory()},resize:function(){var a,b,c,d,e,f,g;this.dom.$controls.toggleClass("drawing-board-controls-hidden",!this.controls||!this.controls.length),b=void 0,a=void 0,g=[this.$el.width(),DrawingBoard.Utils.boxBorderWidth(this.$el),DrawingBoard.Utils.boxBorderWidth(this.dom.$canvasWrapper,!0,!0)],c=[this.$el.height(),DrawingBoard.Utils.boxBorderHeight(this.$el),this.dom.$controls.height(),DrawingBoard.Utils.boxBorderHeight(this.dom.$controls,!1,!0),DrawingBoard.Utils.boxBorderHeight(this.dom.$canvasWrapper,!0,!0)],f=this,e=function(a,b){var c,d;for(b=b||1,d=a[0],c=1;c<a.length;)d+=a[c]*b,c++;return d},d=function(a){return e(a,-1)},this.opts.enlargeYourContainer?(b=this.$el.width(),a=this.$el.height(),this.$el.width(e(g)),this.$el.height(e(c))):(b=d(g),a=d(c)),this.dom.$canvasWrapper.css("width",b+"px"),this.dom.$canvasWrapper.css("height",a+"px"),this.dom.$canvas.css("width",b+"px"),this.dom.$canvas.css("height",a+"px"),this.canvas.width=b,this.canvas.height=a},initControls:function(){var a,b,c;if(this.controls=[],!this.opts.controls.length||!DrawingBoard.Control)return!1;for(c=0;c<this.opts.controls.length;){if(a=null,"string"==typeof this.opts.controls[c])a=new window.DrawingBoard.Control[this.opts.controls[c]](this);else if("object"==typeof this.opts.controls[c]){for(b in this.opts.controls[c]);a=new window.DrawingBoard.Control[b](this,this.opts.controls[c][b])}a&&this.addControl(a),c++}},addControl:function(a,b,c){var d;return"string"!=typeof a&&("object"!=typeof a||!a instanceof DrawingBoard.Control)?!1:(d="object"==typeof b?b:{},c=c?1*c:"number"==typeof b?b:null,"string"==typeof a&&(a=new window.DrawingBoard.Control[a](this,d)),c?this.dom.$controls.children().eq(c).before(a.$el):this.dom.$controls.append(a.$el),this.controls||(this.controls=[]),this.controls.push(a),void this.dom.$controls.removeClass("drawing-board-controls-hidden"))},initHistory:function(){this.history={values:[],position:0}},saveHistory:function(){for(;this.history.values.length>30;)this.history.values.shift(),this.history.position--;0!==this.history.position&&this.history.position<this.history.values.length?(this.history.values=this.history.values.slice(0,this.history.position),this.history.position++):this.history.position=this.history.values.length+1,this.history.values.push(this.getImg()),this.ev.trigger("historyNavigation",this.history.position)},_goThroughHistory:function(a){var b;a&&this.history.position===this.history.values.length||!a&&1===this.history.position||(b=a?this.history.position+1:this.history.position-1,this.history.values.length&&null!=this.history.values[b-1]&&(this.history.position=b,this.setImg(this.history.values[b-1])),this.ev.trigger("historyNavigation",b),this.saveWebStorage())},goBackInHistory:function(){this._goThroughHistory(!1)},goForthInHistory:function(){this._goThroughHistory(!0)},setImg:function(a){var b,c,d;b=this.ctx,c=new Image,d=b.globalCompositeOperation,c.onload=function(){b.globalCompositeOperation="source-over",b.clearRect(0,0,b.canvas.width,b.canvas.width),b.drawImage(c,0,0),b.globalCompositeOperation=d},c.src=a},getImg:function(){return this.canvas.toDataURL("image/png")},downloadImg:function(){var a;a=this.getImg(),a=a.replace("image/png","image/octet-stream"),window.location.href=a},saveWebStorage:function(){window[this.storage]&&(window[this.storage].setItem("drawing-board-"+this.id,this.getImg()),this.ev.trigger("board:save"+this.storage.charAt(0).toUpperCase()+this.storage.slice(1),this.getImg()))},restoreWebStorage:function(){window[this.storage]&&null!==window[this.storage].getItem("drawing-board-"+this.id)&&(this.setImg(window[this.storage].getItem("drawing-board-"+this.id)),this.ev.trigger("board:restore"+this.storage.charAt(0).toUpperCase()+this.storage.slice(1),window[this.storage].getItem("drawing-board-"+this.id)))},clearWebStorage:function(){window[this.storage]&&null!==window[this.storage].getItem("drawing-board-"+this.id)&&(window[this.storage].removeItem("drawing-board-"+this.id),this.ev.trigger("board:clear"+this.storage.charAt(0).toUpperCase()+this.storage.slice(1)))},_getStorage:function(){return!this.opts.webStorage||"session"!==this.opts.webStorage&&"local"!==this.opts.webStorage?!1:this.opts.webStorage+"Storage"},initDropEvents:function(){return this.opts.droppable?(this.dom.$canvas.on("dragover dragenter drop",function(a){a.stopPropagation(),a.preventDefault()}),void this.dom.$canvas.on("drop",$.proxy(this._onCanvasDrop,this))):!1},_onCanvasDrop:function(a){var b,c;return a=a.originalEvent?a.originalEvent:a,b=a.dataTransfer.files,b&&b.length&&-1!==b[0].type.indexOf("image")&&window.FileReader?(c=new FileReader,c.readAsDataURL(b[0]),void(c.onload=$.proxy(function(a){this.setImg(a.target.result),this.ev.trigger("board:imageDropped",a.target.result),this.ev.trigger("board:userAction"),this.saveHistory()},this))):!1},setMode:function(a,b){b=b||!1,a=a||"pencil",this.ev.unbind("board:startDrawing",$.proxy(this.fill,this)),"transparent"===this.opts.eraserColor?this.ctx.globalCompositeOperation="eraser"===a?"destination-out":"source-over":("eraser"===a?"background"===this.opts.eraserColor&&DrawingBoard.Utils.isColor(this.opts.background)?this.ctx.strokeStyle=this.opts.background:DrawingBoard.Utils.isColor(this.opts.eraserColor)&&(this.ctx.strokeStyle=this.opts.eraserColor):this.mode&&"eraser"!==this.mode||(this.ctx.strokeStyle=this.color),"filler"===a&&this.ev.bind("board:startDrawing",$.proxy(this.fill,this))),this.mode=a,b||this.ev.trigger("board:mode",this.mode)},getMode:function(){return this.mode||"pencil"},setColor:function(a){var b,c;return c=this,a=a||this.color,DrawingBoard.Utils.isColor(a)?(this.color=a,void("transparent"!==this.opts.eraserColor&&"eraser"===this.mode?(b=function(a){"eraser"!==a&&(c.strokeStyle=c.color),c.ev.unbind("board:mode",b)},this.ev.bind("board:mode",b)):this.ctx.strokeStyle=this.color)):!1},fill:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(this.getImg()===this.blankCanvas)return this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.width),this.ctx.fillStyle=this.color,void this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);if(h=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),c=0,d=1,e=2,b=3,p=this.ctx.strokeStyle,m=parseInt(p.substr(1,2),16),g=parseInt(p.substr(3,2),16),f=parseInt(p.substr(5,2),16),n=DrawingBoard.Utils.pixelAt(h,parseInt(a.coords.x,10),parseInt(a.coords.y,10)),o=n[b],q=this.opts.fillTolerance,!DrawingBoard.Utils.compareColors(o,DrawingBoard.Utils.RGBToInt(m,g,f),q)){for(l=[n],k=void 0,r=void 0,s=void 0,i=h.width-1,j=h.height-1;k=l.pop();)DrawingBoard.Utils.compareColors(k[b],o,q)&&(h.data[k[c]]=m,h.data[k[c]+1]=g,h.data[k[c]+2]=f,k[d]>0&&l.push(DrawingBoard.Utils.pixelAt(h,k[d]-1,k[e])),k[d]<i&&l.push(DrawingBoard.Utils.pixelAt(h,k[d]+1,k[e])),k[e]>0&&l.push(DrawingBoard.Utils.pixelAt(h,k[d],k[e]-1)),k[e]<j&&l.push(DrawingBoard.Utils.pixelAt(h,k[d],k[e]+1)));this.ctx.putImageData(h,0,0)}},initDrawEvents:function(){this.isDrawing=!1,this.isMouseHovering=!1,this.coords={},this.coords.old=this.coords.current=this.coords.oldMid={x:0,y:0},this.dom.$canvas.on("mousedown touchstart",$.proxy(function(a){this._onInputStart(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mousemove touchmove",$.proxy(function(a){this._onInputMove(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mousemove",$.proxy(function(){},this)),this.dom.$canvas.on("mouseup touchend",$.proxy(function(a){this._onInputStop(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mouseover",$.proxy(function(a){this._onMouseOver(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mouseout",$.proxy(function(a){this._onMouseOut(a,this._getInputCoords(a))},this)),$("body").on("mouseup touchend",$.proxy(function(){this.isDrawing=!1},this)),window.requestAnimationFrame&&requestAnimationFrame($.proxy(this.draw,this))},draw:function(){var a,b;window.requestAnimationFrame&&this.ctx.lineWidth>10&&this.isMouseHovering?(this.dom.$cursor.css({width:this.ctx.lineWidth+"px",height:this.ctx.lineWidth+"px"}),b=DrawingBoard.Utils.tpl("translateX({{x}}px) translateY({{y}}px)",{x:this.coords.current.x-this.ctx.lineWidth/2,y:this.coords.current.y-this.ctx.lineWidth/2}),this.dom.$cursor.css({transform:b,"-webkit-transform":b,"-ms-transform":b}),this.dom.$cursor.removeClass("drawing-board-utils-hidden")):this.dom.$cursor.addClass("drawing-board-utils-hidden"),this.isDrawing&&(a=this._getMidInputCoords(this.coords.current),this.ctx.beginPath(),this.ctx.moveTo(a.x,a.y),this.ctx.quadraticCurveTo(this.coords.old.x,this.coords.old.y,this.coords.oldMid.x,this.coords.oldMid.y),this.ctx.stroke(),this.coords.old=this.coords.current,this.coords.oldMid=a),window.requestAnimationFrame&&requestAnimationFrame($.proxy(function(){this.draw()},this))},_onInputStart:function(a,b){this.coords.current=this.coords.old=b,this.coords.oldMid=this._getMidInputCoords(b),this.isDrawing=!0,window.requestAnimationFrame||this.draw(),this.ev.trigger("board:startDrawing",{e:a,coords:b}),a.stopPropagation(),a.preventDefault()},_onInputMove:function(a,b){this.coords.current=b,this.ev.trigger("board:drawing",{e:a,coords:b}),window.requestAnimationFrame||this.draw(),a.stopPropagation(),a.preventDefault()},_onInputStop:function(a,b){!this.isDrawing||a.touches&&0!==a.touches.length||(this.isDrawing=!1,this.saveWebStorage(),this.saveHistory(),this.ev.trigger("board:stopDrawing",{e:a,coords:b}),this.ev.trigger("board:userAction"),a.stopPropagation(),a.preventDefault())},_onMouseOver:function(a,b){this.isMouseHovering=!0,this.coords.old=this._getInputCoords(a),this.coords.oldMid=this._getMidInputCoords(this.coords.old),this.ev.trigger("board:mouseOver",{e:a,coords:b})},_onMouseOut:function(a,b){this.isMouseHovering=!1,this.ev.trigger("board:mouseOut",{e:a,coords:b})},_getInputCoords:function(a){var b,c;return a=a.originalEvent?a.originalEvent:a,b=void 0,c=void 0,a.touches&&1===a.touches.length?(b=a.touches[0].pageX,c=a.touches[0].pageY):(b=a.pageX,c=a.pageY),{x:b-this.dom.$canvas.offset().left,y:c-this.dom.$canvas.offset().top}},_getMidInputCoords:function(a){return{x:this.coords.old.x+a.x>>1,y:this.coords.old.y+a.y>>1}}},window.DrawingBoard="undefined"!=typeof DrawingBoard?DrawingBoard:{},DrawingBoard.Utils={},DrawingBoard.Utils.tpl=function(){"use strict";var a,b,c,d,e;return d="{{",a="}}",b="[a-z0-9_][\\.a-z0-9_]*",c=new RegExp(d+"\\s*("+b+")\\s*"+a,"gi"),e=void 0,function(a,d){return a.replace(c,function(a,c){var f,g,h;for(b=c.split("."),g=b.length,h=d,f=0;g>f;){if(h=h[b[f]],h===e)throw new Error("tim: '"+b[f]+"' not found in "+a);if(f===g-1)return h;f++}})}}(),DrawingBoard.Utils.MicroEvent=function(){},DrawingBoard.Utils.MicroEvent.prototype={bind:function(a,b){this._events=this._events||{},this._events[a]=this._events[a]||[],this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{},a in this._events!=!1&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){var b;if(this._events=this._events||{},a in this._events!=!1)for(b=0;b<this._events[a].length;)this._events[a][b].apply(this,Array.prototype.slice.call(arguments_,1)),b++}},DrawingBoard.Utils._boxBorderSize=function(a,b,c,d){var e,f,g;for(b=!!b||!0,c=!!c||!1,g=0,f=void 0,"width"===d?(f=["border-left-width","border-right-width"],b&&f.push("padding-left","padding-right"),c&&f.push("margin-left","margin-right")):(f=["border-top-width","border-bottom-width"],b&&f.push("padding-top","padding-bottom"),c&&f.push("margin-top","margin-bottom")),e=f.length-1;e>=0;)g+=parseInt(a.css(f[e]).replace("px",""),10),e--;return g},DrawingBoard.Utils.boxBorderWidth=function(a,b,c){return DrawingBoard.Utils._boxBorderSize(a,b,c,"width")},DrawingBoard.Utils.boxBorderHeight=function(a,b,c){return DrawingBoard.Utils._boxBorderSize(a,b,c,"height")},DrawingBoard.Utils.isColor=function(a){return a&&a.length?/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(a)||-1!==$.inArray(a.substring(0,3),["rgb","hsl"]):!1},DrawingBoard.Utils.RGBToInt=function(a,b,c){var d;return d=0,d|=(255&a)<<16,d|=(255&b)<<8,d|=255&c},DrawingBoard.Utils.pixelAt=function(a,b,c){var d,e;return e=4*(c*a.width+b),d=DrawingBoard.Utils.RGBToInt(a.data[e],a.data[e+1],a.data[e+2]),[e,b,c,d]},DrawingBoard.Utils.compareColors=function(a,b,c){var d,e,f,g,h,i;return 0===c?a===b:(h=a>>16&255,i=b>>16&255,f=a>>8&255,g=b>>8&255,d=255&a,e=255&b,Math.abs(h-i)<=c&&Math.abs(f-g)<=c&&Math.abs(d-e)<=c)},function(){var a,b,c;for(a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"],++c}(),DrawingBoard.Control.Color=DrawingBoard.Control.extend({name:"colors",initialize:function(){var a;this.initTemplate(),a=this,this.$el.on("click",".drawing-board-control-colors-picker",function(b){var c;c=$(this).attr("data-color"),a.board.setColor(c),a.$el.find(".drawing-board-control-colors-current").css("background-color",c).attr("data-color",c),a.board.ev.trigger("color:changed",c),a.$el.find(".drawing-board-control-colors-rainbows").addClass("drawing-board-utils-hidden"),b.preventDefault()}),this.$el.on("click",".drawing-board-control-colors-current",function(b){a.$el.find(".drawing-board-control-colors-rainbows").toggleClass("drawing-board-utils-hidden"),b.preventDefault()}),$("body").on("click",function(b){var c,d,e,f;f=$(b.target),e=f.hasClass("drawing-board-control-colors-current")?f:f.closest(".drawing-board-control-colors-current"),c=a.$el.find(".drawing-board-control-colors-current"),d=a.$el.find(".drawing-board-control-colors-rainbows"),e.length&&e.get(0)===c.get(0)||d.hasClass("drawing-board-utils-hidden")||d.addClass("drawing-board-utils-hidden")})},initTemplate:function(){var a,b,c;c='<div class="drawing-board-control-inner"><div class="drawing-board-control-colors-current" style="background-color: {{color}}" data-color="{{color}}"></div><div class="drawing-board-control-colors-rainbows">{{rainbows}}</div></div>',a='<div class="drawing-board-control-colors-picker" data-color="{{color}}" style="background-color: {{color}}"></div>',b="",$.each([.75,.5,.25],$.proxy(function(c,d){var e,f;for(f=0,e=null,b+='<div class="drawing-board-control-colors-rainbow">',.25===d&&(e=this._rgba(0,0,0,1)),.5===d&&(e=this._rgba(150,150,150,1)),.75===d&&(e=this._rgba(255,255,255,1)),b+=DrawingBoard.Utils.tpl(a,{color:e.toString()});330>=f;)b+=DrawingBoard.Utils.tpl(a,{color:this._hsl2Rgba(this._hsl(f-60,1,d)).toString()}),f+=30;b+="</div>"},this)),this.$el.append($(DrawingBoard.Utils.tpl(c,{color:this.board.color,rainbows:b}))),this.$el.find(".drawing-board-control-colors-rainbows").addClass("drawing-board-utils-hidden")},onBoardReset:function(){this.board.setColor(this.$el.find(".drawing-board-control-colors-current").attr("data-color"))},_rgba:function(a,b,c,d){return{r:a,g:b,b:c,a:d,toString:function(){return"rgba("+a+", "+b+", "+c+", "+d+")"}}},_hsl:function(a,b,c){return{h:a,s:b,l:c,toString:function(){return"hsl("+a+", "+100*b+"%, "+100*c+"%)"}}},_hex2Rgba:function(a){var b;return b=parseInt(a.substring(1),16),this._rgba(b>>16,b>>8&255,255&b,1)},_hsl2Rgba:function(a){var b,c,d,e,f,g,h,i,j;return e=function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a},d=a.h/360,j=a.s,f=a.l,i=void 0,c=void 0,b=void 0,0===j?i=c=b=f:(h=.5>f?f*(1+j):f+j-f*j,g=2*f-h,i=Math.floor(255*e(g,h,d+1/3)),c=Math.floor(255*e(g,h,d)),b=Math.floor(255*e(g,h,d-1/3))),this._rgba(i,c,b,1)}}),DrawingBoard.Control=function(a,b){return this.board=a,this.opts=$.extend({},this.defaults,b),this.$el=$(document.createElement("div")).addClass("drawing-board-control"),this.name&&this.$el.addClass("drawing-board-control-"+this.name),this.board.ev.bind("board:reset",$.proxy(this.onBoardReset,this)),this.initialize.apply(this,arguments_),this},DrawingBoard.Control.prototype={name:"",defaults:{},initialize:function(){},addToBoard:function(){this.board.addControl(this)},onBoardReset:function(){}},DrawingBoard.Control.extend=function(a,b){var c,d,e;return e=this,d=void 0,d=a&&a.hasOwnProperty("constructor")?a.constructor:function(){return e.apply(this,arguments_)},$.extend(d,e,b),c=function(){this.constructor=d},c.prototype=e.prototype,d.prototype=new c,a&&$.extend(d.prototype,a),d.__super__=e.prototype,d},DrawingBoard.Control.Download=DrawingBoard.Control.extend({name:"download",initialize:function(){this.$el.append('<button class="drawing-board-control-download-button"></button>'),this.$el.on("click",".drawing-board-control-download-button",$.proxy(function(a){this.board.downloadImg(),a.preventDefault()},this))}}),DrawingBoard.Control.DrawingMode=DrawingBoard.Control.extend({name:"drawingmode",defaults:{pencil:!0,eraser:!0,filler:!0},initialize:function(){this.prevMode=this.board.getMode(),$.each(["pencil","eraser","filler"],$.proxy(function(a,b){this.opts[b]&&this.$el.append('<button class="drawing-board-control-drawingmode-'+b+'-button" data-mode="'+b+'"></button>')},this)),this.$el.on("click","button[data-mode]",$.proxy(function(a){var b,c,d;d=$(a.currentTarget).attr("data-mode"),b=this.board.getMode(),b!==d&&(this.prevMode=b),c=b===d?this.prevMode:d,this.board.setMode(c),a.preventDefault()},this)),this.board.ev.bind("board:mode",$.proxy(function(a){this.toggleButtons(a)},this)),this.toggleButtons(this.board.getMode())},toggleButtons:function(a){this.$el.find("button[data-mode]").each(function(b,c){var d;d=$(c),d.toggleClass("active",a===d.attr("data-mode"))})}}),DrawingBoard.Control.Navigation=DrawingBoard.Control.extend({name:"navigation",defaults:{back:!0,forward:!0,reset:!0},initialize:function(){var a,b,c;c="",this.opts.back&&(c+='<button class="drawing-board-control-navigation-back">&larr;</button>'),this.opts.forward&&(c+='<button class="drawing-board-control-navigation-forward">&rarr;</button>'),this.opts.reset&&(c+='<button class="drawing-board-control-navigation-reset">&times;</button>'),this.$el.append(c),this.opts.back&&(a=this.$el.find(".drawing-board-control-navigation-back"),this.board.ev.bind("historyNavigation",$.proxy(function(b){1===b?a.attr("disabled","disabled"):a.removeAttr("disabled")},this)),this.$el.on("click",".drawing-board-control-navigation-back",$.proxy(function(a){this.board.goBackInHistory(),a.preventDefault()},this))),this.opts.forward&&(b=this.$el.find(".drawing-board-control-navigation-forward"),this.board.ev.bind("historyNavigation",$.proxy(function(a){a===this.board.history.values.length?b.attr("disabled","disabled"):b.removeAttr("disabled")},this)),this.$el.on("click",".drawing-board-control-navigation-forward",$.proxy(function(a){this.board.goForthInHistory(),a.preventDefault()},this))),this.opts.reset&&this.$el.on("click",".drawing-board-control-navigation-reset",$.proxy(function(a){this.board.reset({background:!0}),a.preventDefault()},this))}}),DrawingBoard.Control.Size=DrawingBoard.Control.extend({name:"size",defaults:{type:"auto",dropdownValues:[1,3,6,10,20,30,40,50]},types:["dropdown","range"],initialize:function(){var a,b;return"auto"===this.opts.type&&(this.opts.type=this._iHasRangeInput()?"range":"dropdown"),(b=$.inArray(this.opts.type,this.types)>-1?this["_"+this.opts.type+"Template"]():!1)?(this.val=this.board.opts.size,this.$el.append($(b)),this.$el.attr("data-drawing-board-type",this.opts.type),this.updateView(),a=this,"range"===this.opts.type&&this.$el.on("change",".drawing-board-control-size-range-input",function(b){a.val=$(this).val(),a.updateView(),a.board.ev.trigger("size:changed",a.val),b.preventDefault()}),void("dropdown"===this.opts.type&&(this.$el.on("click",".drawing-board-control-size-dropdown-current",$.proxy(function(){this.$el.find(".drawing-board-control-size-dropdown").toggleClass("drawing-board-utils-hidden")},this)),this.$el.on("click","[data-size]",function(b){a.val=parseInt($(this).attr("data-size"),0),a.updateView(),a.board.ev.trigger("size:changed",a.val),b.preventDefault()})))):!1},_rangeTemplate:function(){var a;return a='<div class="drawing-board-control-inner" title="{{size}}"><input type="range" min="1" max="50" value="{{size}}" step="1" class="drawing-board-control-size-range-input"><span class="drawing-board-control-size-range-current"></span></div>',DrawingBoard.Utils.tpl(a,{size:this.board.opts.size})},_dropdownTemplate:function(){var a;return a='<div class="drawing-board-control-inner" title="{{size}}"><div class="drawing-board-control-size-dropdown-current"><span></span></div><ul class="drawing-board-control-size-dropdown">',$.each(this.opts.dropdownValues,function(b,c){a+=DrawingBoard.Utils.tpl('<li data-size="{{size}}"><span style="width: {{size}}px; height: {{size}}px; border-radius: {{size}}px;"></span></li>',{size:c})}),a+="</ul></div>"},onBoardReset:function(){this.updateView()},updateView:function(){var a,b;b=this.val,this.board.ctx.lineWidth=b,this.$el.find(".drawing-board-control-size-range-current, .drawing-board-control-size-dropdown-current span").css({width:b+"px",height:b+"px",borderRadius:b+"px",marginLeft:-1*b/2+"px",marginTop:-1*b/2+"px"}),this.$el.find(".drawing-board-control-inner").attr("title",b),"dropdown"===this.opts.type&&(a=null,$.each(this.opts.dropdownValues,function(c,d){(null===a||Math.abs(d-b)<Math.abs(a-b))&&(a=d)}),this.$el.find(".drawing-board-control-size-dropdown").addClass("drawing-board-utils-hidden"))},_iHasRangeInput:function(){var a,b,c,d,e,f;return d=document.createElement("input"),f=":)",c=document.documentElement,e="range",a=void 0,d.setAttribute("type",e),a="text"!==d.type,d.value=f,d.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(e)&&null!=d.style.WebkitAppearance&&(c.appendChild(d),b=document.defaultView,a=b.getComputedStyle&&"textfield"!==b.getComputedStyle(d,null).WebkitAppearance&&0!==d.offsetHeight,c.removeChild(d)),!!a}})}).call(this);